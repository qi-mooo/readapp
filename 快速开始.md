# 快速开始指南

## 📱 iOS 轻阅读应用（后端 HttpTTS 版本）

这是一个简洁高效的 iOS 阅读应用，完美对接你的轻阅读后端服务，**使用后端 HttpTTS 引擎实现高质量听书功能**。

## 🚀 快速启动

### 1. 打开项目

```bash
cd /Users/qimo/Documents/code/read/ReadApp
open ReadApp.xcodeproj
```

### 2. 运行应用

在 Xcode 中：
1. 选择目标设备（iPhone 模拟器或真机）
2. 点击运行按钮（⌘R）

**重要提示**：听书的后台播放功能需要在真机上测试，模拟器可能无法完全体验。

### 3. 首次配置（重要！）

应用启动后会显示设置界面，按以下顺序配置：

#### 步骤 1：配置服务器
1. **服务器地址**：输入你的后端地址
   - 示例：`http://192.168.1.100:8080`
   - 本地测试：`http://127.0.0.1:8080`

2. **访问令牌**：输入你的 accessToken
   - 从后端获取的用户令牌

#### 步骤 2：选择 TTS 引擎（必须！）
⚠️ **这一步必不可少，否则无法使用听书功能！**

1. 点击"TTS 引擎"进入选择页面
2. 应用会自动加载后端配置的所有 TTS 引擎
3. 选择一个你喜欢的引擎
4. 点击"完成"返回

💡 **提示**：如果 TTS 引擎列表为空，需要先在后端添加 TTS 引擎配置。

#### 步骤 3：调整语速（可选）
- 默认语速：10
- 建议范围：10-20
- 可调范围：5-50

## ✨ 主要功能

### 📚 书架功能
- ✅ 显示所有书籍
- ✅ 显示封面、书名、作者
- ✅ 显示最新章节
- ✅ 显示阅读进度
- ✅ 下拉刷新

### 📖 阅读功能
- ✅ 点击书籍直接进入正文
- ✅ 自动加载当前阅读进度
- ✅ 目录浏览（点击列表图标）
- ✅ 上一章/下一章切换
- ✅ 自动保存阅读进度

### 🎧 听书功能（使用后端 HttpTTS）

#### ⭐ 核心优势

1. **高质量语音**
   - 使用后端配置的在线 TTS 引擎
   - 支持多种高质量音色
   - 语音更自然流畅

2. **多引擎支持**
   - 可配置多个 TTS 引擎
   - 随时切换不同音色
   - 灵活选择最佳效果

3. **智能分句**
   - 自动将长文本分句
   - 逐句请求和播放
   - 流畅连续的听书体验

4. **激进的后台保留策略**
   - 应用退到后台后继续播放
   - 锁屏状态下继续播放
   - 支持蓝牙设备播放

5. **系统集成**
   - 锁屏界面显示播放信息
   - 控制中心显示播放控制
   - 支持线控和蓝牙设备控制

6. **智能播放**
   - 自动播放下一句
   - 章节播放完自动切换下一章
   - 后台自动加载下一章内容

7. **播放控制**
   - 播放/暂停
   - 上一章/下一章
   - 可调节语速（5-50）

### ⚙️ 个性化设置

- **TTS 引擎选择**：选择不同的语音引擎
- **字体大小**：12-30 可调
- **行间距**：4-20 可调
- **语速**：5-50 可调（建议 10-20）

## 🎯 使用场景

### 场景 1：通勤听书
1. 打开应用，选择想听的书
2. 点击"喇叭"图标开始听书
3. 锁屏，放入口袋
4. 使用耳机线控或手表控制播放
5. 享受高质量的语音朗读

### 场景 2：睡前阅读
1. 打开应用，选择书籍
2. 调整字体大小和行间距
3. 舒适阅读
4. 自动保存进度

### 场景 3：开车听书
1. 连接车载蓝牙
2. 启动听书功能
3. 使用方向盘控制按钮操作
4. 自动播放下一章

## 🔧 技术实现

### HttpTTS 工作流程

```
用户点击听书
    ↓
将章节内容分句（按句号、问号等）
    ↓
对每一句：
  1. 构建 TTS API URL
     /api/3/tts?id=引擎ID&speakText=文本&speechRate=10
  2. AVPlayer 请求音频流
  3. 播放音频
  4. 监听播放完成
    ↓
播放下一句
    ↓
当前章节完成 → 自动加载下一章
```

### 关键技术点

```swift
// 1. 获取 TTS 引擎列表
let ttsList = try await apiService.fetchTTSList()

// 2. 构建音频 URL
let audioURL = apiService.buildTTSAudioURL(
    ttsId: selectedTTSId,
    text: sentence,
    speechRate: 10
)

// 3. 使用 AVPlayer 播放
let playerItem = AVPlayerItem(url: audioURL)
player = AVPlayer(playerItem: playerItem)
player.play()

// 4. 监听播放完成
NotificationCenter.default.addObserver(
    self,
    selector: #selector(playerDidFinishPlaying),
    name: .AVPlayerItemDidPlayToEndTime,
    object: nil
)
```

### 后台音频保留的关键技术

```swift
// 1. Info.plist 配置
<key>UIBackgroundModes</key>
<array>
    <string>audio</string>
</array>

// 2. 音频会话配置
AVAudioSession.setCategory(.playback, mode: .spokenAudio)

// 3. 远程控制集成
MPRemoteCommandCenter.shared()
```

## 📝 API 对接

应用使用以下后端 API（版本 3）：

| 接口 | 说明 | 听书相关 |
|------|------|---------|
| `/api/3/getBookshelf` | 获取书架列表 | - |
| `/api/3/getChapterList` | 获取章节列表 | - |
| `/api/3/getBookContent` | 获取章节内容 | ✅ 用于分句 |
| `/api/3/saveBookProgress` | 保存阅读进度 | - |
| `/api/3/getalltts` | 获取 TTS 引擎列表 | ✅ 核心 |
| `/api/3/getdefaulttts` | 获取默认 TTS | ✅ |
| `/api/3/tts` | 获取音频流 | ✅ 核心 |

## ⚠️ 重要注意事项

### 1. TTS 引擎配置
- **必须先在后端添加 TTS 引擎配置**
- 后端配置路径：后台管理 → TTS 引擎管理
- 常见 TTS 引擎：
  - 阿里云 TTS
  - 百度 TTS
  - 讯飞 TTS
  - 腾讯云 TTS
  - 微软 Azure TTS
  - Edge TTS

### 2. 网络要求
- 听书功能需要持续的网络连接
- 建议使用 WiFi 或流量充足的环境
- 每次朗读都会请求服务器

### 3. 真机测试
- 后台音频功能必须在真机上测试
- 模拟器可能无法正确处理后台音频
- 建议使用 iOS 15.0 或更高版本

### 4. 权限要求
- 无需额外权限
- 自动处理音频会话

## 🐛 故障排除

### 问题：听书无声音
**症状**：点击听书按钮后没有声音

**排查步骤**：
1. ✅ 检查是否选择了 TTS 引擎
   - 设置 → TTS 引擎 → 应该有选中的引擎
2. ✅ 检查网络连接
   - 确保设备有网络连接
   - 尝试访问服务器地址
3. ✅ 查看 Xcode 控制台
   - 查找错误信息
   - 检查 API 请求是否成功
4. ✅ 测试后端 TTS
   - 在浏览器访问：`http://服务器地址/api/3/tts?accessToken=xxx&id=引擎ID&speakText=测试&speechRate=10`
   - 应该返回音频文件

### 问题：TTS 引擎列表为空
**症状**：打开 TTS 引擎选择页面，显示"暂无 TTS 引擎"

**解决方案**：
1. 登录后端管理界面
2. 添加 TTS 引擎配置
3. 回到应用，点击"刷新"重新加载

### 问题：听书后台不播放
**症状**：锁屏或切换应用后停止播放

**解决方案**：
1. 确保在真机上测试
2. 检查 Info.plist 中的 UIBackgroundModes 配置
3. 重新构建项目
4. 检查网络连接是否稳定

### 问题：播放卡顿
**症状**：播放不流畅，频繁中断

**原因**：
- 网络不稳定
- 服务器响应慢
- TTS 引擎性能问题

**解决方案**：
1. 切换到更稳定的网络
2. 尝试其他 TTS 引擎
3. 降低语速

## 📦 项目结构

```
ReadApp/
├── ReadApp.xcodeproj          # Xcode 项目文件
├── ReadApp/
│   ├── ReadAppApp.swift       # 应用入口
│   ├── ContentView.swift      # 主视图
│   ├── Info.plist            # 应用配置（包含后台音频）
│   ├── Models/
│   │   └── Models.swift      # 数据模型（含 HttpTTS）
│   ├── Services/
│   │   ├── APIService.swift  # API 服务（含 TTS API）
│   │   └── TTSManager.swift  # TTS 管理器（AVPlayer）
│   ├── Views/
│   │   ├── BookListView.swift      # 书架
│   │   ├── ReadingView.swift       # 阅读页面
│   │   ├── SettingsView.swift      # 设置
│   │   └── TTSSelectionView.swift  # TTS 引擎选择
│   └── Assets.xcassets/      # 资源文件
├── README.md                  # 详细文档
└── 快速开始.md               # 本文件
```

## 🎨 界面预览

- **书架页面**：瀑布流式书籍列表
- **阅读页面**：简洁的阅读界面
- **设置页面**：服务器配置和个性化设置
- **TTS 选择页面**：选择不同的语音引擎
- **目录页面**：章节列表

## 💡 开发提示

1. **修改 API 版本**：在 `APIService.swift` 中修改 `apiVersion`
2. **调整分句规则**：在 `TTSManager.swift` 的 `splitTextIntoSentences` 方法
3. **自定义 UI**：所有视图都在 `Views/` 目录下

## 🔄 数据流

```
用户操作
    ↓
SwiftUI View
    ↓
APIService (获取 TTS 引擎列表)
    ↓
TTSManager (管理播放)
    ↓
构建 TTS URL
    ↓
AVPlayer 请求音频流
    ↓
播放音频
    ↓
监听完成 → 播放下一句/下一章
```

## 🎉 开始使用

1. **配置后端 TTS 引擎**（如果还没有）
   ```
   登录后端管理界面 → TTS 引擎管理 → 添加引擎
   ```

2. **打开项目**
   ```bash
   open ReadApp.xcodeproj
   ```

3. **运行应用**
   - 选择真机
   - 点击运行（⌘R）

4. **配置应用**
   - 输入服务器地址和令牌
   - **选择 TTS 引擎**
   - 开始享受高质量听书！

## 🆚 与系统 TTS 版本的区别

| 特性 | 系统 TTS | 后端 HttpTTS（当前版本） |
|------|---------|------------------------|
| 语音质量 | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| 离线使用 | ✅ | ❌ |
| 流量消耗 | 无 | 持续消耗 |
| 多引擎 | ❌ | ✅ |
| 自定义音色 | ❌ | ✅ |
| 配置要求 | 简单 | 需要后端配置 |

现在你拥有了一个功能强大、语音质量优秀的听书应用！🎉📚🎧
